# Domo AI - Code Architecture Guide

## Overview
This document provides a comprehensive guide to the Domo AI codebase architecture, including project structure, component organization, data flow patterns, and development guidelines.

## Root Directory Structure

### âœ… Essential Configuration Files

#### **Package Management**
- **`package.json`** - Project dependencies, scripts, and metadata. Contains all npm commands and project configuration.
- **`package-lock.json`** - Exact dependency versions for reproducible builds. Auto-generated, ensures consistent installs.

#### **TypeScript & Build Configuration**
- **`tsconfig.json`** - TypeScript compiler configuration. Defines paths, strict mode, and compilation targets.
- **`next.config.cjs`** - Next.js framework configuration. Handles webpack, headers, security policies, and Sentry integration.
- **`next-env.d.ts`** - Next.js TypeScript definitions. Auto-generated type declarations for Next.js features.

#### **Styling & UI Configuration**
- **`tailwind.config.js`** - Tailwind CSS configuration. Custom colors, fonts, animations, and responsive breakpoints.
- **`postcss.config.cjs`** - PostCSS configuration for CSS processing. Handles Tailwind CSS compilation.

#### **Code Quality & Testing**
- **`eslint.config.js`** - ESLint configuration for code linting. Enforces code style and catches potential errors.
- **`jest.config.cjs`** - Main Jest testing configuration. Defines test environments and module resolution.
- **`jest.config.dom.cjs`** - DOM-specific Jest configuration for React component testing.
- **`jest.config.node.cjs`** - Node.js-specific Jest configuration for API and server-side testing.
- **`jest.setup.js`** - Jest global setup for all test environments.
- **`jest.setup.node.js`** - Node.js-specific Jest setup for server-side tests.
- **`jest.env.js`** - Environment variable setup for Jest tests.

#### **End-to-End Testing**
- **`playwright.config.ts`** - Playwright E2E testing configuration for mocked environments.
- **`playwright.real.config.ts`** - Playwright configuration for real API integration testing.

#### **Environment Configuration**
- **`.env.example`** - Template showing required environment variables. Safe to commit, no secrets.
- **`.env.development`** - Development environment variables. Used for local development and testing.
- **`.env.staging`** - Staging environment configuration. Used for pre-production testing.
- **`.env.production`** - Production environment configuration. Contains production API keys and URLs.

#### **Version Control & Deployment**
- **`.gitignore`** - Git ignore patterns. Excludes build artifacts, secrets, and temporary files.
- **`.dockerignore`** - Docker ignore patterns for container builds.
- **`docker-compose.yml`** - Docker container orchestration for local development.
- **`Dockerfile`** - Docker container definition for production deployment.
- **`render.yaml`** - Render.com deployment configuration for staging and production.

#### **Documentation**
- **`README.md`** - Main project documentation. Setup instructions, architecture overview, and development guide.

## Why These Files Must Be in Root Directory

### **Critical for Build Process**
- **`package.json`** - Required by Node.js/npm to identify project and manage dependencies
- **`tsconfig.json`** - Required by TypeScript compiler to find and compile source files
- **`next.config.cjs`** - Required by Next.js framework for build configuration
- **`tailwind.config.js`** - Required by Tailwind CSS for style compilation

### **Essential for Development Workflow**
- **`eslint.config.js`** - Must be in root for ESLint to find and apply rules to entire project
- **`jest.config.cjs`** - Required by Jest test runner to configure test environment
- **`playwright.config.ts`** - Required by Playwright for E2E test configuration

### **Required by Deployment Systems**
- **`package-lock.json`** - Required by deployment platforms for exact dependency resolution
- **`Dockerfile`** - Required by Docker for container builds
- **`render.yaml`** - Required by Render.com for deployment configuration
- **`.gitignore`** - Required by Git for version control exclusions

### **Framework Conventions**
- **`next-env.d.ts`** - Auto-generated by Next.js, must be in root for TypeScript integration
- **`jest.setup.js`** - Referenced by Jest config, must be accessible from root
- **`postcss.config.cjs`** - Required by build tools for CSS processing

### **Environment & Security**
- **`.env.*` files** - Must be in root for Next.js automatic environment variable loading
- **`README.md`** - GitHub/Git convention for project documentation visibility

## What Should NOT Be in Root Directory

### **Documentation Files (Belong in `docs/`)**
- **Why**: Keeps root clean and organized, easier to find specific documentation
- **Examples**: `log.md`, `DEPLOYMENT_GUIDE.md`, `API_DOCS.md`, `CHANGELOG.md`
- **Benefit**: Centralized documentation location, better project navigation

### **Script Files (Belong in `scripts/`)**
- **Why**: Separates executable scripts from configuration, prevents root clutter
- **Examples**: `setup.js`, `deploy.sh`, `seed-data.js`, `build-utils.js`
- **Benefit**: Clear separation of concerns, easier script management

### **Database Files (Belong in `scripts/` or `data/`)**
- **Why**: Database schemas and migrations are operational scripts, not configuration
- **Examples**: `schema.sql`, `migrations/`, `seed-data.sql`
- **Benefit**: Organized data management, clear database versioning

### **Images & Media (Belong in `public/` or `assets/`)**
- **Why**: Media files should be served by the web server, not mixed with configuration
- **Examples**: `logo.png`, `screenshot.jpg`, `demo-video.mp4`
- **Benefit**: Proper web asset organization, better performance

### **Temporary & Debug Files (Should be deleted)**
- **Why**: Temporary files create clutter and can contain sensitive information
- **Examples**: `debug.log`, `temp-data.json`, `*.backup`, `*.tmp`
- **Benefit**: Clean repository, no accidental secret commits

### **Build Artifacts (Auto-generated, git-ignored)**
- **Why**: Build outputs should not be committed, they're generated from source
- **Examples**: `dist/`, `build/`, `.next/`, `coverage/`
- **Benefit**: Smaller repository size, no merge conflicts on generated files

## Root Directory Compliance

### **Automated Checking**
```bash
# Check compliance before committing
npm run check:root

# Expected output:
âœ… Root directory is compliant with project structure guidelines!
```

### **Manual Verification**
```bash
# Quick file count check (should be ~26 files)
ls -la | grep -v "^d" | wc -l

# List only configuration files
ls *.json *.js *.cjs *.ts *.md *.yml *.yaml 2>/dev/null
```

### **Common Violations & Fixes**
```bash
# Move documentation files
mv *.md docs/ (except README.md)

# Move script files  
mv *.sh *.js scripts/ (except config files)

# Delete temporary files
rm *.log *.tmp *.backup *.old

# Move database files
mv *.sql scripts/
```

### ğŸ—ï¸ Auto-Generated Directories

#### **Build & Cache Directories**
- **`.next/`** - Next.js build output (~409MB). Contains compiled pages, API routes, and static assets.
- **`.swc/`** - SWC compiler cache. Auto-managed by Next.js for faster builds.
- **`node_modules/`** - NPM dependencies. Auto-generated from package.json, git-ignored.
- **`coverage/`** - Test coverage reports. Generated by Jest, contains HTML and JSON coverage data.

#### **Test Artifacts**
- **`test-artifacts/`** - Consolidated test output directory.
  - **`test-artifacts/results/`** - Playwright screenshots, videos, and traces.
  - **`test-artifacts/reports/`** - HTML test reports and summaries.

## Project Architecture Structure

### Domain-Driven Organization
```
src/
â”œâ”€â”€ app/                           # Next.js App Router
â”‚   â”œâ”€â”€ api/                       # API routes by domain
â”‚   â”‚   â”œâ”€â”€ admin/                 # Administrative functions
â”‚   â”‚   â”œâ”€â”€ auth/                  # Authentication endpoints
â”‚   â”‚   â”œâ”€â”€ demos/                 # Demo management APIs
â”‚   â”‚   â”œâ”€â”€ tavus/                 # Tavus integration APIs
â”‚   â”‚   â””â”€â”€ webhooks/              # Webhook processing
â”‚   â”œâ”€â”€ auth/                      # Authentication pages
â”‚   â”œâ”€â”€ dashboard/                 # Main dashboard
â”‚   â”œâ”€â”€ demos/                     # Demo management pages
â”‚   â””â”€â”€ globals.css                # Global styles
â”œâ”€â”€ components/                    # React components
â”‚   â”œâ”€â”€ ui/                        # Reusable UI components (atoms/molecules)
â”‚   â”œâ”€â”€ features/                  # Feature-specific components (organisms)
â”‚   â””â”€â”€ layout/                    # Layout components (templates)
â”œâ”€â”€ lib/                          # Business logic and utilities
â”‚   â”œâ”€â”€ services/                  # Domain services
â”‚   â”œâ”€â”€ utils/                     # Shared utilities
â”‚   â””â”€â”€ types/                     # TypeScript type definitions
â”œâ”€â”€ docs/                         # Project documentation
â”œâ”€â”€ scripts/                      # Build and utility scripts
â””â”€â”€ __tests__/                    # Test files
    â”œâ”€â”€ unit/                      # Unit tests
    â”œâ”€â”€ integration/               # Integration tests
    â”œâ”€â”€ e2e/                       # End-to-end tests
    â””â”€â”€ lib/                       # Test utilities
```

## Reporting System Architecture

### Main Components
- **`Reporting.tsx`** - Main container component that orchestrates data fetching and layout
- **`reporting/` folder** - Individual specialized components for different data types

### Component Hierarchy
```
Reporting.tsx (Main Container)
â”œâ”€â”€ ContactInfoCard.tsx (Contact/qualification data)
â”œâ”€â”€ ProductInterestCard.tsx (Interest and pain points)
â”œâ”€â”€ VideoShowcaseCard.tsx (Video requests and fulfillment)
â”œâ”€â”€ CtaTrackingCard.tsx (CTA engagement tracking)
â””â”€â”€ DomoScoreCard.tsx (Overall engagement scoring)
```

## Data Flow

### Database Tables
- **`conversation_details`** - Main conversation metadata (status, duration, transcript)
- **`qualification_data`** - Contact information captured during conversations
- **`product_interest_data`** - Product interests and pain points identified
- **`video_showcase_data`** - Videos requested and shown during demos
- **`cta_tracking`** - Call-to-action engagement metrics

### Data Fetching Pattern
1. Fetch conversations from `conversation_details` table
2. Extract `tavus_conversation_id` values for related data lookup
3. Fetch related data from specialized tables using conversation IDs
4. Convert arrays to lookup objects keyed by conversation ID
5. Pass data to individual components for rendering

## Component Responsibilities

### Reporting.tsx (Main Container)
- Data fetching and state management
- Conversation list rendering
- Expandable conversation details coordination
- Summary statistics calculation

### Individual Cards
- **ContactInfoCard**: Display captured contact information (name, email, position)
- **ProductInterestCard**: Show primary interests and identified pain points
- **VideoShowcaseCard**: Display requested vs. shown videos with engagement
- **CtaTrackingCard**: Track CTA presentation and click-through rates
- **DomoScoreCard**: Calculate and display overall engagement score (0-5 points)

## Interface Consistency

### Required Fields (All Data Interfaces)
```typescript
interface BaseReportingData {
  id: string;
  conversation_id: string;
  objective_name: string;
  event_type: string;
  raw_payload: any;
  received_at: string;
}
```

### Specific Interfaces
- Extend `BaseReportingData` with domain-specific fields
- Maintain consistency between main `Reporting.tsx` and individual components
- Use nullable types for optional fields (`string | null`, `string[] | null`)

## API Architecture

### Route Organization
```
src/app/api/
â”œâ”€â”€ admin/                         # Administrative functions
â”‚   â”œâ”€â”€ check/                     # System health checks
â”‚   â”œâ”€â”€ debug/                     # Debug endpoints
â”‚   â”œâ”€â”€ test/                      # Testing utilities
â”‚   â”œâ”€â”€ utilities/                 # Admin utilities
â”‚   â””â”€â”€ verify/                    # Verification endpoints
â”œâ”€â”€ auth/                          # Authentication
â”‚   â”œâ”€â”€ session/                   # Session management
â”‚   â”œâ”€â”€ setup-test-user/           # Test user creation
â”‚   â””â”€â”€ user/                      # User operations
â”œâ”€â”€ demos/                         # Demo management
â”‚   â”œâ”€â”€ [demoId]/                  # Demo-specific operations
â”‚   â”‚   â”œâ”€â”€ custom-objectives/     # Custom objectives CRUD
â”‚   â”‚   â”œâ”€â”€ persona/               # Persona management
â”‚   â”‚   â”œâ”€â”€ sync/                  # Data synchronization
â”‚   â”‚   â””â”€â”€ update-persona/        # Persona updates
â”‚   â”œâ”€â”€ agents/                    # Agent creation
â”‚   â”œâ”€â”€ check-current-persona/     # Persona status
â”‚   â””â”€â”€ create-test/               # Test demo creation
â”œâ”€â”€ tavus/                         # Tavus API integration
â”‚   â”œâ”€â”€ conversations/             # Conversation management
â”‚   â”œâ”€â”€ debug/                     # Tavus debugging
â”‚   â”œâ”€â”€ perception/                # AI perception features
â”‚   â”œâ”€â”€ personas/                  # Persona management
â”‚   â”œâ”€â”€ videos/                    # Video operations
â”‚   â””â”€â”€ webhook/                   # Tavus webhooks
â””â”€â”€ webhooks/                      # Webhook processing
    â”œâ”€â”€ data/                      # Data retrieval endpoints
    â”œâ”€â”€ events/                    # Event processing
    â”œâ”€â”€ cta-click/                 # CTA tracking
    â”œâ”€â”€ set-url/                   # URL management
    â”œâ”€â”€ test/                      # Webhook testing
    â””â”€â”€ update-urls/               # URL updates
```

### API Route Patterns
- **Dynamic Routes**: Use `[param]` for dynamic segments
- **Route Groups**: Organize related endpoints in folders
- **HTTP Methods**: Separate GET, POST, PUT, DELETE in same route file
- **Dynamic Exports**: All API routes use `export const dynamic = 'force-dynamic'`

## Service Layer Architecture

### Domain Services
```
src/lib/services/
â”œâ”€â”€ auth/                          # Authentication services
â”‚   â”œâ”€â”€ middleware.ts              # Auth middleware
â”‚   â””â”€â”€ session.ts                 # Session management
â”œâ”€â”€ demos/                         # Demo business logic
â”‚   â”œâ”€â”€ demo-service.ts            # Core demo operations
â”‚   â”œâ”€â”€ agent-service.ts           # Agent creation logic
â”‚   â””â”€â”€ video-service.ts           # Video management
â”œâ”€â”€ tavus/                         # Tavus integration
â”‚   â”œâ”€â”€ tavus-service.ts           # Main Tavus API client
â”‚   â”œâ”€â”€ analytics-service.ts       # Analytics processing
â”‚   â””â”€â”€ conversation-service.ts    # Conversation management
â””â”€â”€ webhooks/                      # Webhook processing
    â”œâ”€â”€ event-processing-service.ts # Event handling
    â””â”€â”€ data-capture-service.ts    # Data extraction
```

### Service Responsibilities
- **Business Logic**: Core application logic separate from API routes
- **External API Integration**: Tavus, ElevenLabs, Supabase clients
- **Data Processing**: Transform and validate data between layers
- **Error Handling**: Consistent error patterns across services

## Component Architecture

### UI Component Hierarchy
```
src/components/
â”œâ”€â”€ ui/                            # Atomic components
â”‚   â”œâ”€â”€ button.tsx                 # Base button component
â”‚   â”œâ”€â”€ input.tsx                  # Form inputs
â”‚   â”œâ”€â”€ card.tsx                   # Card containers
â”‚   â””â”€â”€ badge.tsx                  # Status indicators
â”œâ”€â”€ features/                      # Feature components
â”‚   â”œâ”€â”€ auth/                      # Authentication UI
â”‚   â”œâ”€â”€ demos/                     # Demo management UI
â”‚   â”œâ”€â”€ reporting/                 # Analytics components
â”‚   â””â”€â”€ conversation/              # Conversation interface
â””â”€â”€ layout/                        # Layout components
    â”œâ”€â”€ header.tsx                 # Site header
    â”œâ”€â”€ sidebar.tsx                # Navigation sidebar
    â””â”€â”€ footer.tsx                 # Site footer
```

### Component Guidelines
- **Single Responsibility**: Each component has one clear purpose
- **Composition**: Build complex UI from simple, reusable components
- **Props Interface**: Well-defined TypeScript interfaces for all props
- **Error Boundaries**: Graceful error handling in component tree

## Development Guidelines

### File Organization Rules
1. **Domain Grouping**: Group related functionality together
2. **Layer Separation**: Keep presentation, business logic, and data layers separate
3. **Consistent Naming**: Use descriptive, consistent file and folder names
4. **Index Files**: Use index.ts for clean imports from folders

### Code Quality Standards
- **TypeScript**: Full type safety throughout the application
- **ESLint**: Consistent code style and error prevention
- **Jest Testing**: Comprehensive unit and integration test coverage
- **File Size Limits**: Maximum 500 lines per file, target 300-400 lines

### API Development Patterns
- **Route Handlers**: Use Next.js App Router API conventions
- **Error Handling**: Consistent error responses and logging
- **Authentication**: Middleware-based auth for protected routes
- **Validation**: Input validation using TypeScript and runtime checks

### Database Integration
- **Supabase Client**: Centralized database access patterns
- **Type Safety**: Generated types from database schema
- **RLS Policies**: Row-level security for data protection
- **Migration Management**: Version-controlled schema changes

### Testing Strategy
- **Unit Tests**: Individual function and component testing
- **Integration Tests**: API endpoint and service integration
- **E2E Tests**: Full user workflow validation with Playwright
- **Real API Tests**: Production-like testing with actual services

## Scoring System (DomoScoreCard)

### 5-Point Engagement Scale
1. **Contact Confirmation** - Name, email, or position captured
2. **Reason for Visit** - Primary interest or pain points identified
3. **Platform Feature Interest** - Videos requested or shown
4. **CTA Execution** - Call-to-action clicked
5. **Visual Analysis** - Valid perception analysis available

### Score Interpretation
- **4-5 points**: Excellent engagement (Green)
- **3 points**: Good engagement (Blue)
- **2 points**: Fair engagement (Yellow)
- **0-1 points**: Poor engagement (Red)

## File Organization

### âœ… Correct Structure
```
src/app/demos/[demoId]/configure/components/
â”œâ”€â”€ Reporting.tsx                    # Main container
â””â”€â”€ reporting/
    â”œâ”€â”€ index.ts                     # Exports
    â”œâ”€â”€ ContactInfoCard.tsx          # Contact data
    â”œâ”€â”€ ProductInterestCard.tsx      # Interest data
    â”œâ”€â”€ VideoShowcaseCard.tsx        # Video data
    â”œâ”€â”€ CtaTrackingCard.tsx         # CTA data
    â””â”€â”€ DomoScoreCard.tsx           # Scoring
```

### âŒ Avoid
- Putting all logic in single file
- Inconsistent interface definitions
- Direct database queries in components
- Mixing data fetching with presentation logic

## Integration Points

### Webhook Processing
- Data flows from Tavus webhooks â†’ specialized tables â†’ reporting components
- Objective completion events populate `qualification_data`, `product_interest_data`
- Video showcase events populate `video_showcase_data`
- CTA events populate `cta_tracking`

### Real-time Updates
- Components refresh when new webhook data arrives
- Sync functionality pulls latest data from Tavus API
- Conversation status updates reflect in real-time